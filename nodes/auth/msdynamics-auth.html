<script type="text/javascript">
  RED.nodes.registerType("msdynamics-auth", {
    category: "MSDynamics",
    defaults: {
      name: { value: "" },
      clientId: { value: "", required: true },
      tenantId: { value: "", required: true },
      instanceUrl: { value: "", required: true },
      autoRefresh: { value: true, required: true }, // Enable auto-refresh by default
      refreshInterval: { value: 30, required: true }, // Default refresh interval in minutes
      retryInterval: { value: 15, required: true }, // Default retry interval in minutes
      tokenEndpoint: { value: "", required: false },
      grantType: { value: "", required: false },
      scopeSuffix: { value: "", required: false },
      host: { value: "", required: false },
      storageKey: { value: "msDynamicsToken", required: false },
    },
    credentials: {
      clientSecret: { type: "text", required: true },
    },
    label: () => this.name || "MS Dynamics Auth",
    description: "Node for managing Microsoft Dynamics authentication",
    color: "#A6E1FA",
    icon: "font-awesome/fa-key",
    inputs: 1, // Define one input
    outputs: 2, // Define two outputs
    outputLabels: ["Success", "Failure"],
    oneditprepare: () => {
      const updateTokenEndpoint = () => {
        const tenantId = $("#node-input-tenantId").val();
        const host = $("#node-input-host").val() || "login.microsoftonline.com";
        const tokenEndpoint = `https://${host}/${tenantId}/oauth2/v2.0/token`;
        $("#node-input-tokenEndpoint").val(tokenEndpoint);
      };

      $("#node-input-tenantId, #node-input-host").on(
        "change",
        updateTokenEndpoint
      );
      updateTokenEndpoint(); // Call on edit prepare to initialize value

      const updateFieldsState = () => {
        const isAutoRefreshChecked = $("#node-input-autoRefresh").is(
          ":checked"
        );
        $("#node-input-refreshInterval").prop(
          "disabled",
          !isAutoRefreshChecked
        );
        $("#node-input-retryInterval").prop("disabled", !isAutoRefreshChecked);
      };

      updateFieldsState();
      $("#node-input-autoRefresh").on("change", updateFieldsState);
    },
    oneditsave: () => {
      const autoRefresh = $("#node-input-autoRefresh").is(":checked");
      let refreshInterval = $("#node-input-refreshInterval").val().trim();
      let retryInterval = $("#node-input-retryInterval").val().trim();

      if (autoRefresh && (refreshInterval === "" || retryInterval === "")) {
        RED.notify(
          "Refresh Interval and Retry Interval cannot be empty when Auto Refresh is enabled",
          "error"
        );
        return false;
      }

      $("#node-input-refreshInterval").val(refreshInterval);
      $("#node-input-retryInterval").val(retryInterval);
    },
  });
</script>

<script type="text/x-red" data-help-name="msdynamics-auth">
  <p>This node manages authentication with Microsoft Dynamics by handling access token generation and refresh. It stores the refreshed access token in the Node-RED global context under the key <code>msDynamicsToken</code>, which includes the <code>accessToken</code> string and the <code>expiresAt</code> timestamp.</p>

  <p>To directly access the <code>accessToken</code> in your flows, use:</p>
  <pre><code>const accessToken = global.get("msDynamicsToken.accessToken");</code></pre>
  <p>If <code>accessToken</code> is available, it can be used for authenticated API calls to Microsoft Dynamics.</p>

  <p><strong>Inputs and Outputs:</strong></p>
  <ul>
      <li><strong>Input:</strong> The node has one input, used for manually triggering a token refresh. This is mainly for testing or building your own token refresh logic. The input does not process the incoming message content.</li>
      <li><strong>Outputs:</strong> There are two outputs. The first sends success messages with token details upon refresh, and the second sends error messages if the refresh fails. These outputs are optional for debugging purposes, especially useful when not using AutoRefresh.</li>
  </ul>

  <p><strong>AutoRefresh Mode:</strong></p>
  <ul>
      <li><strong>Enabled:</strong> The node automatically refreshes the token at set intervals ('Refresh Interval' and 'Retry Interval'). In this mode, manual input and outputs are not necessary, just deploy and configure the node.</li>
      <li><strong>Disabled:</strong> Manual triggering is required for token refresh. Send any message to the input as a trigger. Monitor outputs to manage refresh results.</li>
  </ul>
  <p>For both modes, the token is refreshed when the flow is deployed or Node-RED restarts.</p>
  <p>Errors are always logged, but for detailed error messages, a debug node is recommended.</p>
  <p><strong>Note:</strong> Storing sensitive information like access tokens in the global context allows any node in the flow to access it. Ensure to follow best security practices in handling such sensitive information.</p>
  <p><strong>Note:</strong> The fields for Token Endpoint, Grant Type, Scope Suffix, and Host have default values that are suitable for most use cases. Only modify these if your specific Microsoft Dynamics setup requires different values.</p>
</script>

<script type="text/x-red" data-template-name="msdynamics-auth">
        <div class="form-row">
            <label for="node-input-name"><i class="icon-tag"></i> Name</label>
            <input type="text" id="node-input-name" placeholder="Name">
        </div>
        <div class="form-row">
            <label for="node-input-clientId"><i class="icon-user"></i> Client ID</label>
            <input type="text" id="node-input-clientId" placeholder="Client ID">
        </div>
        <div class="form-row">
            <label for="node-input-tenantId">Tenant ID</label>
            <input type="text" id="node-input-tenantId" placeholder="Tenant ID">
        </div>
        <div class="form-row">
            <label for="node-input-instanceUrl">Instance URL</label>
            <input type="text" id="node-input-instanceUrl" placeholder="https://yourinstance.crm4.dynamics.com/">
        </div>
        <div class="form-row">
            <label for="node-input-clientSecret">Client Secret</label>
            <input type="password" id="node-input-clientSecret">
        </div>
        <div class="form-row">
          <label for="node-input-autoRefresh"><i class="fa fa-refresh"></i> Enable Auto Refresh</label>
          <input type="checkbox" id="node-input-autoRefresh" style="display: inline-block; width: auto; vertical-align: top;">
      </div>
      <div class="form-row">
          <label for="node-input-refreshInterval">Refresh Interval (minutes)</label>
          <input type="number" id="node-input-refreshInterval" placeholder="30">
      </div>
      <div class="form-row">
          <label for="node-input-retryInterval">Retry Interval (minutes)</label>
          <input type="number" id="node-input-retryInterval" placeholder="15">
      </div>
      <div class="form-row">
        <p style="color: #555; margin-top: 4px; margin-bottom: 4px;">
            <strong>Note:</strong> The following are advanced settings and should not be changed.
        </p>
        <p>
          Leave them empty to use the defaults.
      </p>
    </div>
      <div class="form-row">
        <label for="node-input-tokenEndpoint">Token Endpoint</label>
        <input type="text" id="node-input-tokenEndpoint" readonly>
    </div>
    <div class="form-row">
        <label for="node-input-grantType">Grant Type</label>
        <input type="text" id="node-input-grantType" placeholder="client_credentials">
    </div>
    <div class="form-row">
        <label for="node-input-scopeSuffix">Scope Suffix</label>
        <input type="text" id="node-input-scopeSuffix" placeholder=".default">
    </div>
    <div class="form-row">
        <label for="node-input-host">Host</label>
        <input type="text" id="node-input-host" placeholder="login.microsoftonline.com">
    </div>
    <div class="form-row">
      <label for="node-input-storageKey">Storage Key</label>
      <input type="text" id="node-input-storageKey" placeholder="msDynamicsToken">
  </div>
</script>
